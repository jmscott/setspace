#!/bin/bash
#
#  Synopsis:
#	Find all blobs with known unknowns, across all schemas.
#  Usage:
#	rummy | cut -f2 | xargs bio-file
#  Note:
#		$ rummy
#		libxml2\tsha:01871af3ae0a6af9096c3155c5741453b8eb83b8
#		jsonorg\tsha:fef573f2fd3c76002e71f048c120abc0e0a3965f
#
#		$ rummy | cut -f2 | sort -u
#
#	letting the caller filter by schema.
#

PROG=$(basename $0)

die()
{
	echo "$PROG: ERROR: $@" >&2
	exit 1
}

test $# = 0 || die 'wrong number of arguments'

test -n "$SETSPACE_ROOT" || die "env variable not defined: SETSPACE_ROOT"
cd $SETSPACE_ROOT || die "cd $SETSPACE_ROOT failed"

find-schema | while read SCH;  do
	SQL=schema/$SCH/lib/rummy.sql
	test -e $SQL || continue
	psql								\
		--tuples-only						\
		--file $SQL						\
		--no-psqlrc						\
		--quiet							|
	  sed '/^ *$/d'							|
	  sed 's/ //g'							|
	  sed "s/.*/$SCH	&/"
STATUS=${PIPESTATUS[*]}
test STATUS='0 0 0 0' || die "psql $SQL | sed failed: exit status=$STATUS"
done
