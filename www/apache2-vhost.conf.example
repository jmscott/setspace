#
#  Synopsis:
#       Apache2 Site specific configuration for setspace controller web gui
#
#  Description:
#	The apache variables are prefixed SETSPACE.
#	Although this example is for dash.setspace.com, configurations
#	is identical for noc.setspace.com.  Doing s/\<dash\>/noc/g ought to
#	work.
#
#	For desktop/dev environment, change these variables.
#
#		SETSPACE_APACHE2_SERVER_NAME
#		SETSPACE_APACHE2_SERVER_PORT
#		SETSPACE_PATH
#		SETSPACE_PERL5LIB	
#		SETSPACE_PG*	
#		SETSPACE_BLOBIO_SERVICE
#		SETSPACE_BLOBIO_GET_SERVICE
#		<VirtualHost>
#			SSLEngine
#			SSLCertificateFile
#			SSLCertificateKeyFile
#		</VirtualHost>
#
Define SETSPACE_APACHE2_SERVER_NAME dash.setspace.com
Define SETSPACE_PERL5LIB /usr/local/jmscott/lib:/usr/local/setspace/vhost/dash/lib/

#  the full setspace installation
Define SETSPACE_APACHE2_SERVER_PORT 443
Define SETSPACE_ROOT /usr/local/setspace

Define SETSPACE_PGHOST
Define SETSPACE_PGHOST 127.0.0.1
Define SETSPACE_PGPORT 5432
Define SETSPACE_PGUSER postgres
Define SETSPACE_PGDATABASE setspace 

Define SETSPACE_BLOBIO_SERVICE bio4:127.0.0.1:1797
Define SETSPACE_BLOBIO_GET_SERVICE fs:/usr/local/blobio
Define SETSPACE_BLOBIO_ALGORITHM bc160

Define SETSPACE_PATH /usr/local/pgsql/bin:/usr/local/blobio/bin:/usr/bin:/bin

#  Define on Mac OS/X under ports distro, which does not define
<IfDefine !APACHE_LOG_DIR>
	Define APACHE_LOG_DIR /opt/local/log
</IfDefine>

#
#  Synopsis:
#	Example development Apache2 configuration for setspace web gui.
#  Note:
#	See toolkit at https://github.com/jmscott/work/tree/master/httpd2
#	for reference in PERL5LIB to /usr/local/jmscott/httpd2/lib
#
Listen ${SETSPACE_APACHE2_SERVER_PORT}
<VirtualHost ${SETSPACE_APACHE2_SERVER_NAME}:${SETSPACE_APACHE2_SERVER_PORT}>
	LogLevel warn
        ServerName ${SETSPACE_APACHE2_SERVER_NAME}
	SetEnv SETSPACE_ROOT ${SETSPACE_ROOT}
	SetEnv SERVER_ROOT ${SETSPACE_ROOT}/www/vhost/${SETSPACE_APACHE2_SERVER_NAME}

	SetEnv PGHOST ${SETSPACE_PGHOST}
	SetEnv PGPORT ${SETSPACE_PGPORT}
	SetEnv PGUSER ${SETSPACE_PGUSER}
	<IfDefine SETSPACE_PGPASSWORD>
		SetEnv PGPASSWORD ${SETSPACE_PGPASSWORD}
	</IfDefine>
	SetEnv PGDATABASE ${SETSPACE_PGDATABASE}

	SetEnv BLOBIO_SERVICE ${SETSPACE_BLOBIO_SERVICE}
	SetEnv BLOBIO_GET_SERVICE ${SETSPACE_BLOBIO_GET_SERVICE}
	SetEnv BLOBIO_ALGORITHM ${SETSPACE_BLOBIO_ALGORITHM}

	SetEnv PATH ${SETSPACE_PATH}

	#  Note:See https://github.com/jmscott/work/tree/master/httpd2
	#
	SetEnv PERL5LIB ${SETSPACE_PERL5LIB}

	DocumentRoot "${SETSPACE_ROOT}/www/vhost/${SETSPACE_APACHE2_SERVER_NAME}/htdocs"

	#  Disable chatty logging to preserve write limits on secure drives.

	CustomLog ${APACHE_LOG_DIR}/${SETSPACE_APACHE2_SERVER_NAME}-access.log common

	#  Note: log to syslog to improved secure drive write limits

	ErrorLog ${APACHE_LOG_DIR}/${SETSPACE_APACHE2_SERVER_NAME}-error.log

	<Directory />
            AllowOverride all
            Require all granted
        </Directory>

	<Directory "${SETSPACE_ROOT}/www/vhost/${SETSPACE_APACHE2_SERVER_NAME}">
		Options Indexes FollowSymLinks
		AllowOverride None
		Require all granted
	</Directory>

	DirectoryIndex index.shtml

	<Directory "${SETSPACE_ROOT}/www/vhost/${SETSPACE_APACHE2_SERVER_NAME}/htdocs">
                Options +ExecCGI +Includes +FollowSymLinks

                AddType text/html .shtml
                AddOutputFilter INCLUDES .shtml

		AuthType Basic
		AuthName "${SETSPACE_APACHE2_SERVER_NAME}"
		AuthUserFile ${SETSPACE_ROOT}/www/vhost/${SETSPACE_APACHE2_SERVER_NAME}/etc/passwd
		Require valid-user
	</Directory>

	ScriptAlias /cgi-bin/ "${SETSPACE_ROOT}/www/vhost/${SETSPACE_APACHE2_SERVER_NAME}/cgi-bin/"
	<Directory "${SETSPACE_ROOT}/www/vhost/${SETSPACE_APACHE2_SERVER_NAME}/cgi-bin">
                AllowOverride all
                Allow from all

                Options None +ExecCGI +Includes +FollowSymLinks

                AuthType Basic
                AuthName "SetSpace ${SETSPACE_APACHE2_SERVER_NAME}"
                AuthBasicProvider file
		AuthUserFile ${SETSPACE_ROOT}/www/vhost/${SETSPACE_APACHE2_SERVER_NAME}/etc/passwd
                Require valid-user
        </Directory>

	#  openssl genrsa -out ca.key 1024
	#  openssl req -new -key ca.key -out ca.csr
	#  openssl x509 -req -days 365 -in ca.csr -signkey ca.key -out ca.crt

	SSLEngine on
	SSLCertificateFile etc/apache2/extra/${SETSPACE_APACHE2_SERVER_NAME}.crt
	SSLCertificateKeyFile etc/apache2/extra/${SETSPACE_APACHE2_SERVER_NAME}.key

</VirtualHost>
